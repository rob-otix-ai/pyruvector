name: Release to PyPI

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      test_pypi:
        description: 'Publish to TestPyPI instead of PyPI'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build wheels for all platforms using Maturin
  build-linux:
    name: Build Linux (${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [x86_64, aarch64]
    steps:
      - uses: actions/checkout@v6

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist -i python3.9 -i python3.10 -i python3.11 -i python3.12 -i python3.13
          sccache: 'true'
          manylinux: auto

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-${{ matrix.target }}
          path: dist/*.whl
          retention-days: 7

  build-macos:
    name: Build macOS (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-13
            target: x86_64
          - os: macos-14
            target: aarch64
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v5
        with:
          python-version: |
            3.9
            3.10
            3.11
            3.12
            3.13

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist -i python3.9 -i python3.10 -i python3.11 -i python3.12 -i python3.13
          sccache: 'true'

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.target }}
          path: dist/*.whl
          retention-days: 7

  build-windows:
    name: Build Windows (x86_64)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v5
        with:
          python-version: |
            3.9
            3.10
            3.11
            3.12
            3.13

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: x64
          args: --release --out dist -i python3.9 -i python3.10 -i python3.11 -i python3.12 -i python3.13
          sccache: 'true'

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-windows-x64
          path: dist/*.whl
          retention-days: 7

  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: dist/*.tar.gz
          retention-days: 7

  publish-testpypi:
    name: Publish to TestPyPI
    runs-on: ubuntu-latest
    if: github.event.inputs.test_pypi == 'true'
    needs: [build-linux, build-macos, build-windows, build-sdist]
    environment:
      name: testpypi
      url: https://test.pypi.org/p/pyruvector
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: List artifacts to publish
        run: |
          ls -lh dist/
          echo "Files to publish:"
          echo "  Source distributions: $(ls -1 dist/*.tar.gz 2>/dev/null | wc -l)"
          echo "  Wheels: $(ls -1 dist/*.whl 2>/dev/null | wc -l)"

      - name: Publish to TestPyPI with Maturin
        uses: PyO3/maturin-action@v1
        with:
          command: upload
          args: --non-interactive --skip-existing dist/*
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.TEST_PYPI_API_TOKEN }}
          MATURIN_REPOSITORY_URL: https://test.pypi.org/legacy/

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    if: (github.event_name == 'release' && github.event.action == 'published') || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))
    needs: [build-linux, build-macos, build-windows, build-sdist]
    environment:
      name: pypi
      url: https://pypi.org/p/pyruvector
    steps:
      - uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: List artifacts to publish
        run: |
          ls -lh dist/
          echo "Files to publish:"
          echo "  Source distributions: $(ls -1 dist/*.tar.gz 2>/dev/null | wc -l)"
          echo "  Wheels: $(ls -1 dist/*.whl 2>/dev/null | wc -l)"

      - name: Verify release version matches tag
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            TAG_VERSION="${{ github.event.release.tag_name }}"
          else
            TAG_VERSION="${GITHUB_REF#refs/tags/}"
          fi
          TAG_VERSION="${TAG_VERSION#v}"  # Remove 'v' prefix if present

          # Extract version from sdist filename
          SDIST_FILE=$(ls dist/*.tar.gz | head -1)
          SDIST_VERSION=$(basename "$SDIST_FILE" .tar.gz | sed 's/pyruvector-//')

          echo "Release tag version: $TAG_VERSION"
          echo "Package version: $SDIST_VERSION"

          if [ "$TAG_VERSION" != "$SDIST_VERSION" ]; then
            echo "Error: Version mismatch between tag ($TAG_VERSION) and package ($SDIST_VERSION)"
            exit 1
          fi

          echo "Version verification passed âœ“"

      - name: Publish to PyPI with Maturin
        uses: PyO3/maturin-action@v1
        with:
          command: upload
          args: --non-interactive --skip-existing dist/*
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

      - name: Create GitHub Release assets
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create deployment summary
        if: success()
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi

          echo "## ðŸš€ PyPI Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** pyruvector" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**PyPI URL:** https://pypi.org/project/pyruvector/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh dist/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Install with: \`pip install pyruvector\`" >> $GITHUB_STEP_SUMMARY
